# C ì¶”ë¡  ì—”ì§„ Makefile
# í•˜ì´ë¸Œë¦¬ë“œ ë¡œê·¸ ì´ìƒíƒì§€ ì‹œìŠ¤í…œ

# ì»´íŒŒì¼ëŸ¬ ë° í”Œë˜ê·¸
CC = gcc
CFLAGS = -std=c99 -Wall -Wextra -O2 -fPIC
DEBUG_FLAGS = -g -DDEBUG -O0
INCLUDES = -I./include -I/usr/local/include
LIBS = -lonnxruntime -lm -lpthread

# ë””ë ‰í† ë¦¬
SRCDIR = src
INCDIR = include
OBJDIR = obj
BINDIR = bin

# ì†ŒìŠ¤ íŒŒì¼
SOURCES = $(wildcard $(SRCDIR)/*.c)
OBJECTS = $(SOURCES:$(SRCDIR)/%.c=$(OBJDIR)/%.o)
TARGET = $(BINDIR)/inference_engine

# ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒ€ê²Ÿ
LIBNAME = libinference_engine
STATIC_LIB = $(BINDIR)/$(LIBNAME).a
SHARED_LIB = $(BINDIR)/$(LIBNAME).so

# ê¸°ë³¸ íƒ€ê²Ÿ
.PHONY: all clean debug install test help

all: $(TARGET)

# ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
$(TARGET): $(OBJECTS) | $(BINDIR)
	$(CC) $(OBJECTS) -o $@ $(LIBS)
	@echo "âœ… Built executable: $@"

# ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ
static: $(STATIC_LIB)

$(STATIC_LIB): $(filter-out $(OBJDIR)/main.o,$(OBJECTS)) | $(BINDIR)
	ar rcs $@ $^
	@echo "âœ… Built static library: $@"

# ë™ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ
shared: $(SHARED_LIB)

$(SHARED_LIB): $(filter-out $(OBJDIR)/main.o,$(OBJECTS)) | $(BINDIR)
	$(CC) -shared -o $@ $^ $(LIBS)
	@echo "âœ… Built shared library: $@"

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ë¹Œë“œ
$(OBJDIR)/%.o: $(SRCDIR)/%.c | $(OBJDIR)
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ë””ë ‰í† ë¦¬ ìƒì„±
$(OBJDIR):
	mkdir -p $(OBJDIR)

$(BINDIR):
	mkdir -p $(BINDIR)

# ë””ë²„ê·¸ ë¹Œë“œ
debug: CFLAGS += $(DEBUG_FLAGS)
debug: clean $(TARGET)
	@echo "âœ… Built debug version"

# ì •ë¦¬
clean:
	rm -rf $(OBJDIR) $(BINDIR)
	@echo "ğŸ§¹ Cleaned build files"

# ì„¤ì¹˜ (ì‹œìŠ¤í…œ ì „ì—­)
install: $(TARGET) $(STATIC_LIB) $(SHARED_LIB)
	@echo "ğŸ“¦ Installing inference engine..."
	sudo cp $(TARGET) /usr/local/bin/
	sudo cp $(STATIC_LIB) /usr/local/lib/
	sudo cp $(SHARED_LIB) /usr/local/lib/
	sudo cp $(INCDIR)/*.h /usr/local/include/
	sudo ldconfig
	@echo "âœ… Installation complete"

# ì œê±°
uninstall:
	@echo "ğŸ—‘ï¸ Uninstalling inference engine..."
	sudo rm -f /usr/local/bin/inference_engine
	sudo rm -f /usr/local/lib/$(LIBNAME).*
	sudo rm -f /usr/local/include/inference_engine.h
	sudo ldconfig
	@echo "âœ… Uninstallation complete"

# í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë° ì‹¤í–‰
test: $(TARGET)
	@echo "ğŸ§ª Running basic tests..."
	@if [ ! -f "test_models/vocab.json" ]; then \
		echo "âš ï¸ Test models not found. Creating dummy files..."; \
		mkdir -p test_models; \
		echo '{"0": "INFO User <*> logged in", "1": "ERROR Authentication failed"}' > test_models/vocab.json; \
	fi
	@echo "Running test mode..."
	./$(TARGET) -d test_models/deeplog.onnx -v test_models/vocab.json -t || echo "âš ï¸ Test requires actual ONNX models"

# ì˜ì¡´ì„± í™•ì¸
check-deps:
	@echo "ğŸ” Checking dependencies..."
	@pkg-config --exists onnxruntime 2>/dev/null && echo "âœ… ONNX Runtime found" || echo "âŒ ONNX Runtime not found"
	@which gcc >/dev/null && echo "âœ… GCC found" || echo "âŒ GCC not found"
	@echo "ğŸ’¡ To install ONNX Runtime:"
	@echo "   wget https://github.com/microsoft/onnxruntime/releases/download/v1.16.0/onnxruntime-linux-x64-1.16.0.tgz"
	@echo "   tar -xzf onnxruntime-linux-x64-1.16.0.tgz"
	@echo "   sudo cp onnxruntime-linux-x64-1.16.0/lib/* /usr/local/lib/"
	@echo "   sudo cp -r onnxruntime-linux-x64-1.16.0/include/* /usr/local/include/"
	@echo "   sudo ldconfig"

# ë²¤ì¹˜ë§ˆí¬
benchmark: $(TARGET)
	@echo "âš¡ Running performance benchmark..."
	@echo "Generating test data..."
	@for i in {1..10000}; do \
		echo "2024-01-01 10:00:$$i INFO Test log line $$i"; \
	done > test_data.log
	@echo "Running benchmark..."
	@time ./$(TARGET) -d test_models/deeplog.onnx -v test_models/vocab.json -i test_data.log -o /dev/null || echo "âš ï¸ Benchmark requires actual models"
	@rm -f test_data.log

# ë©”ëª¨ë¦¬ ê²€ì‚¬ (valgrind í•„ìš”)
memcheck: debug
	@echo "ğŸ” Running memory check..."
	@which valgrind >/dev/null || (echo "âŒ valgrind not found. Install with: sudo apt-get install valgrind"; exit 1)
	valgrind --leak-check=full --show-leak-kinds=all ./$(TARGET) -d test_models/deeplog.onnx -v test_models/vocab.json -t

# ì½”ë“œ í¬ë§·íŒ… (clang-format í•„ìš”)
format:
	@echo "ğŸ¨ Formatting code..."
	@which clang-format >/dev/null || (echo "âŒ clang-format not found"; exit 1)
	find $(SRCDIR) $(INCDIR) -name "*.c" -o -name "*.h" | xargs clang-format -i
	@echo "âœ… Code formatted"

# ì •ì  ë¶„ì„ (cppcheck í•„ìš”)
analyze:
	@echo "ğŸ”¬ Running static analysis..."
	@which cppcheck >/dev/null || (echo "âŒ cppcheck not found. Install with: sudo apt-get install cppcheck"; exit 1)
	cppcheck --enable=all --std=c99 $(SRCDIR)

# ë„ì›€ë§
help:
	@echo "ğŸ› ï¸ C Inference Engine Build System"
	@echo ""
	@echo "Targets:"
	@echo "  all        - Build executable (default)"
	@echo "  static     - Build static library"
	@echo "  shared     - Build shared library"
	@echo "  debug      - Build debug version"
	@echo "  clean      - Remove build files"
	@echo "  install    - Install system-wide"
	@echo "  uninstall  - Remove system installation"
	@echo "  test       - Run basic tests"
	@echo "  benchmark  - Run performance benchmark"
	@echo "  memcheck   - Run memory leak check"
	@echo "  format     - Format source code"
	@echo "  analyze    - Run static analysis"
	@echo "  check-deps - Check dependencies"
	@echo "  help       - Show this help"
	@echo ""
	@echo "Usage Examples:"
	@echo "  make                    # Build executable"
	@echo "  make debug              # Build with debug info"
	@echo "  make static shared      # Build libraries"
	@echo "  make test               # Run tests"
	@echo "  make install            # Install system-wide"
	@echo ""
	@echo "Dependencies:"
	@echo "  - GCC compiler"
	@echo "  - ONNX Runtime C API"
	@echo "  - pthread library"
	@echo "  - math library"

# ì˜ì¡´ì„± ì •ë³´
$(OBJDIR)/onnx_engine.o: $(INCDIR)/inference_engine.h
$(OBJDIR)/log_parser.o: $(INCDIR)/inference_engine.h
$(OBJDIR)/anomaly_detector.o: $(INCDIR)/inference_engine.h
$(OBJDIR)/main.o: $(INCDIR)/inference_engine.h
